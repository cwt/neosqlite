# NeoSQLite v1.2.2 Release Notes

## Overview

This release enhances the `$elemMatch` operator to support simple value matching in JSON arrays, making it fully compatible with MongoDB's behavior. The release maintains full backward compatibility while adding this important functionality that was missing in previous versions.

## Highlights

### $elemMatch Operator Enhancement

- **Simple Value Support**: The `$elemMatch` operator now supports simple value matching in JSON arrays, making it compatible with MongoDB behavior
- **Backward Compatibility**: Maintains full backward compatibility with existing complex object matching functionality  
- **Bug Fix**: Fixes issue where `{"tags": {"$elemMatch": "c"}}` did not work with simple arrays like `["a", "b", "c", "d"]`
- **MongoDB Compatibility**: Now supports both simple value matching (`{"tags": {"$elemMatch": "c"}}`) and complex object matching (`{"tags": {"$elemMatch": {"name": "value"}}}`) as per MongoDB specification

## New Features

### Enhanced $elemMatch Operator

- **Simple Array Matching**: The `$elemMatch` operator now correctly handles queries like `{"tags": {"$elemMatch": "c"}}` with arrays containing simple values like `["a", "b", "c", "d"]`
- **Complex Object Matching**: Continues to support the existing functionality for arrays containing objects like `{"tags": {"$elemMatch": {"name": "value"}}}` with `[{"name": "tag1", "value": 1}, {"name": "tag2", "value": 2}]`
- **Mixed Array Support**: Works correctly with mixed arrays containing different value types like `[1, "hello", {"type": "object"}, 42]`
- **Empty Array Handling**: Properly handles empty arrays and non-existent fields as expected

### Query Examples

The following queries now work correctly:

```python
# Simple value matching (NEW)
collection.find({"tags": {"$elemMatch": "c"}})  # Matches documents with ["a", "b", "c", "d"]

# Complex object matching (EXISTING)
collection.find({"tags": {"$elemMatch": {"name": "value"}}})  # Matches documents with [{"name": "tag1"}, {"name": "tag2"}]

# Number matching (NEW)
collection.find({"numbers": {"$elemMatch": 3}})  # Matches documents with [1, 2, 3, 4]

# Mixed type matching (NEW)
collection.find({"mixed": {"$elemMatch": "hello"}})  # Matches documents with [1, "hello", {"type": "object"}, 42]
```

## Internal Improvements

- **Query Operator Enhancement**: Updated `_elemMatch` function in `neosqlite/query_operators.py` to handle both dictionary and simple value parameters
- **Type Safety**: Improved type annotations for the `_elemMatch` function to accept `Any` instead of only `Dict[str, Any]`
- **Test Coverage**: Added comprehensive test cases for simple value matching in `tests/test_query_engine_suite.py`
- **Performance**: Maintains the same performance characteristics as the previous implementation
- **Code Quality**: Enhanced documentation and code clarity for the `$elemMatch` implementation

## API Changes

### $elemMatch Operator Behavior Update

The `$elemMatch` operator now has enhanced functionality:

- **Input Parameter**: Now accepts both dictionaries (for complex object matching) and simple values (for simple array matching)
- **Return Value**: Returns the same boolean result as before, but now works with a broader range of input patterns
- **Backward Compatibility**: All existing code using complex object matching continues to work unchanged

## Technical Benefits

- **MongoDB Compatibility**: Improved compatibility with MongoDB's `$elemMatch` operator behavior
- **Enhanced Functionality**: Full support for both simple and complex array matching scenarios
- **Backward Compatibility**: Full support for existing code with automatic compatibility
- **Robust Implementation**: Proper error handling for empty arrays, non-existent fields, and mixed data types
- **Comprehensive Testing**: New test cases ensure reliability across different data scenarios

## Migration Notes

### For Existing Code

All existing code continues to work unchanged. The `$elemMatch` operator enhancements are fully backward compatible with existing complex object matching functionality.

### New Usage Patterns

The following new usage patterns are now available:

```python
# Previously this would not work:
result = collection.find({"tags": {"$elemMatch": "c"}})  # Now works with ["a", "b", "c", "d"]

# Previously this worked and continues to work:
result = collection.find({"tags": {"$elemMatch": {"name": "value"}}})  # Still works with [{"name": "tag1"}, {"name": "tag2"}]
```

## Installation

```bash
# Standard installation
pip install neosqlite==1.2.2

# For enhanced JSON/JSONB support  
pip install neosqlite[jsonb]==1.2.2

# For memory-constrained processing of large result sets
pip install neosqlite[memory-constrained]==1.2.2

# Install multiple extras
pip install neosqlite[jsonb,memory-constrained]==1.2.2
```

This release represents continued improvement in NeoSQLite's MongoDB compatibility, with enhanced `$elemMatch` functionality providing better support for array matching scenarios while maintaining full backward compatibility with existing applications.