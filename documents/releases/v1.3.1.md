# NeoSQLite v1.3.1 Release Notes

## Overview

This is a bug fix release that enables full PyMongo-style `db.fs.files` collection access by automatically delegating GridFS operations to the `GridFSBucket` API. This includes `find()`, `find_one()`, `delete_one()`, and `delete_many()` operations. This fix provides better MongoDB compatibility while maintaining backward compatibility with existing code.

## Bug Fixes

### GridFS Collection Access

**Fixed**: `connection.fs.files.find()`, `find_one()`, `delete_one()`, and `delete_many()` now work correctly

**Before (v1.3.0)**:
```python
conn.fs.files.find({"filename": "test.txt"})      # ❌ "no such column: data"
conn.fs.files.find_one({"filename": "test.txt"})  # ❌ "no such column: data"
conn.fs.files.delete_one({"filename": "test.txt"}) # ❌ Deletes from wrong schema
```

**After (v1.3.1)**:
```python
conn.fs.files.find({"filename": "test.txt"})      # ✅ Works! Returns GridOut objects
conn.fs.files.find_one({"filename": "test.txt"})  # ✅ Works! Returns GridOut object
conn.fs.files.delete_one({"filename": "test.txt"}) # ✅ Works! Properly deletes file + chunks
conn.fs.files.delete_many({"filename": {...}})    # ✅ Works! Properly deletes files + chunks
```

**How it works**: The `Collection` methods (`find()`, `find_one()`, `delete_one()`, `delete_many()`) now detect GridFS system collections (tables ending with `_files` or `_chunks`) and automatically delegate to the corresponding `GridFSBucket` methods which understand the GridFS schema.

### Documentation Corrections

- **Clarified GridFS API Scope**: Updated documentation to clearly distinguish between GridFS system collection access and full GridFS operations
- **Corrected PyMongo Compatibility Claims**: Removed misleading "drop-in replacement" language for GridFS collection operations
- **Added Usage Guidance**: Documented recommended patterns for GridFS operations vs. system collection queries

### Release Notes Corrections

- **v1.3.0 Notes Updated**: Corrected release notes to accurately reflect the scope of GridFS collection access
- **Installation Version**: Updated installation instructions to reference correct version number

## Known Limitations

### GridFS Collection Access

As of v1.3.1, `find()`, `find_one()`, `delete_one()`, and `delete_many()` operations now work correctly on GridFS system collections. However, some limitations remain:

1. **Schema Differences**: GridFS system collections use a different schema than regular collections
   - **GridFS**: `(id, _id, filename, length, chunkSize, uploadDate, md5, metadata)`
   - **Regular**: `(id, _id, data)`

2. **Write Operations**: Insert operations on GridFS collections should use `GridFSBucket` API:
   - ❌ `conn.fs.files.insert_one({...})` - Won't create proper GridFS entries (no chunks)
   - ✅ `bucket.upload_from_stream()` - Properly creates file + chunks

3. **Projection/Hint**: `projection` and `hint` parameters are not supported for GridFS collections

4. **Complex Filters**: Some complex query filters may not work with `bucket.find()` delegation (pre-existing limitation)

### Working Operations

The following operations work correctly with nested collection access:

```python
# Find queries (NEW in v1.3.1!)
conn.fs.files.find({"filename": "document.pdf"})      # ✅ Works!
conn.fs.files.find_one({"filename": "test.txt"})      # ✅ Works!
conn.fs.chunks.find({"files_id": 1})                  # ✅ Works!

# Delete operations (NEW in v1.3.1!)
conn.fs.files.delete_one({"filename": "old.txt"})     # ✅ Works! Deletes file + chunks
conn.fs.files.delete_many({"filename": {...}})        # ✅ Works! Deletes files + chunks

# Metadata updates (already worked)
conn.fs.files.update_one(
    {"_id": file_id},
    {"$set": {"metadata": {"status": "processed"}}}
)
```

### Recommended Operations

For full GridFS functionality, still use the GridFSBucket API:

```python
from neosqlite.gridfs import GridFSBucket

bucket = GridFSBucket(conn.db)

# Upload (recommended)
file_id = bucket.upload_from_stream("file.txt", data)

# Download (recommended)
with bucket.open_download_stream(file_id) as grid_out:
    content = grid_out.read()

# Query (recommended)
cursor = bucket.find({"metadata.status": "processed"})
files = list(cursor)

# Delete (recommended)
bucket.delete(file_id)
```

## Documentation Updates

### Updated Files

- `documents/releases/v1.3.0.md`: Corrected GridFS API descriptions
- `CHANGELOG.md`: Updated v1.3.0 entry with accurate GridFS API scope
- `README.md`: Clarified GridFS usage patterns

### New Guidance

Added clear documentation distinguishing between:

1. **System Collection Access**: Direct access to `fs_files` and `fs_chunks` tables for administrative operations
2. **GridFS Operations**: Full file management using the `GridFSBucket` API

## Installation

```bash
# Standard installation
pip install neosqlite==1.3.1

# For enhanced JSON/JSONB support
pip install neosqlite[jsonb]==1.3.1

# For memory-constrained processing of large result sets
pip install neosqlite[memory-constrained]==1.3.1

# Install multiple extras
pip install neosqlite[jsonb,memory-constrained]==1.3.1
```

## Upgrade Notes

### From v1.3.0

This release includes code changes that enhance GridFS collection access. No breaking changes are introduced - all existing code continues to work.

**New capabilities in v1.3.1:**
- `conn.fs.files.find()` - Now works via automatic delegation
- `conn.fs.files.find_one()` - Now works via automatic delegation
- `conn.fs.files.delete_one()` - Now works via automatic delegation
- `conn.fs.files.delete_many()` - Now works via automatic delegation

**GridFS functionality** remains compatible with v1.3.0, with enhanced PyMongo-style access patterns.

### For New Users

You can now use PyMongo-style collection access for most GridFS operations:
- `conn.fs.files.find()` for queries
- `conn.fs.files.delete_one()` for deletions
- `conn.fs.files.update_one()` for metadata updates

For uploads, still use the `GridFSBucket` API:
- `bucket.upload_from_stream()` - Creates file + chunks properly

## Testing

### New Test Cases

- **`test_gridfs_collection_access_limitations`**: Documents GridFS collection access capabilities, including:
  - Verifies `update_one()` works for metadata updates
  - Verifies `find()` now works via GridFSBucket delegation
  - Verifies `find_one()` now works via GridFSBucket delegation
  - Demonstrates correct usage of `bucket.find()` for GridFS queries
  - Shows direct SQL access for administrative operations

- **`test_gridfs_recommended_usage_pattern`**: Demonstrates recommended API patterns:
  - Upload/download/delete using `GridFSBucket` API
  - Metadata updates using nested collection access
  - Complex queries using `bucket.find()`

- **`test_gridfs_collection_schema_detection`**: Verifies GridFS detection uses schema verification:
  - Regular collections named `my_files` are NOT treated as GridFS
  - Regular collections named `data_chunks` are NOT treated as GridFS
  - Actual GridFS `fs_files` collection IS delegated correctly
  - Actual GridFS `fs_chunks` collection IS delegated correctly

## Compatibility

- **Backward Compatible**: All existing code continues to work unchanged
- **No Breaking Changes**: This release only clarifies documentation and corrects misleading statements
- **API Stability**: GridFS API remains stable between v1.3.0 and v1.3.1

## Future Enhancements

Future releases may add:
- Direct `GridFSBucket.find_one()` method (convenience wrapper)
- Direct `GridFSBucket.delete_one()` and `GridFSBucket.delete_many()` methods
- Helper methods like `get_last_version()`, `list()`, `get_version()`
- Additional metadata fields like `content_type`, `aliases`
