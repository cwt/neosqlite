# NeoSQLite v1.2.3 Release Notes

## Overview

This release fixes a critical bug in ObjectId type conversion for reference fields, restoring full MongoDB-compatible API behavior for queries on fields like `parent_post`, `author_id`, and `user_id`. The enhancement extends the existing ID normalization logic to handle ObjectId values in all fields, not just `_id` and `id`.

## Highlights

### ObjectId Type Conversion for Reference Fields

- **Bug Fix**: Fixed bug where `ObjectId` values in reference fields (e.g., `parent_post`, `author_id`, `user_id`) were not being properly converted for database queries
- **Enhanced ID Normalization**: Extended `normalize_id_query_for_db()` to handle `ObjectId` conversion in all fields, not just `_id` and `id`
- **Operator Support**: Added proper `ObjectId`-to-string conversion for values in `$in` and `$or` operators across reference fields
- **MongoDB Compatibility**: Restored MongoDB-compatible API behavior for queries on reference fields containing `ObjectId` values

## New Features

### Enhanced ID Normalization

- **Reference Field Support**: The `normalize_id_query_for_db()` function now converts `ObjectId` values to their string representation for all reference fields, not just `_id` and `id`
- **List Processing**: Extended list processing to convert `ObjectId` values in `$in` and `$or` operators for proper database queries
- **Multiple Field Handling**: Correctly handles queries with multiple reference fields containing `ObjectId` values
- **Mixed Type Support**: Properly handles queries with mixed types (integers, strings, ObjectIds) across different fields

### Query Examples

The following queries now work correctly:

```python
# Reference field with ObjectId (FIXED)
collection.find({"author_id": ObjectId("507f1f77bcf86cd799439011")})

# Multiple reference fields (FIXED)
collection.find({
    "author_id": ObjectId("507f1f77bcf86cd799439011"),
    "parent_post": ObjectId("507f191e810c19729de860ea")
})

# $in operator with ObjectIds (FIXED)
collection.find({"user_id": {"$in": [ObjectId("507f1f77bcf86cd799439011"), ObjectId("507f191e810c19729de860ea")]}})

# $or operator with ObjectIds (FIXED)
collection.find({"$or": [{"author_id": ObjectId("507f1f77bcf86cd799439011")}, {"status": "published"}]})

# Complex nested queries (FIXED)
collection.find({
    "author_id": ObjectId("507f1f77bcf86cd799439011"),
    "$or": [{"tags": {"$in": ["python", "mongodb"]}}, {"status": "featured"}]
})
```

## Internal Improvements

- **Type Correction Enhancement**: Updated `normalize_id_query_for_db()` in `neosqlite/collection/type_correction.py` to handle `ObjectId` conversion for all reference fields
- **List Processing**: Enhanced list processing to convert `ObjectId` values in `$in` and `$or` operators
- **Documentation**: Updated docstring to document the new behavior for reference field conversion
- **Test Coverage**: Added 10 comprehensive unit tests covering various `ObjectId` conversion scenarios
- **Code Quality**: Maintains DRY principles with centralized ID normalization logic

## API Changes

### ID Normalization Behavior Update

The `normalize_id_query_for_db()` function now has enhanced functionality:

- **Scope**: Now processes `ObjectId` values in all fields, not just `_id` and `id`
- **Operator Support**: Handles `ObjectId` conversion within `$in` and `$or` operators
- **Return Value**: Returns the same normalized query structure, but with proper `ObjectId`-to-string conversion for reference fields
- **Backward Compatibility**: All existing code continues to work unchanged

## Technical Benefits

- **MongoDB Compatibility**: Full compatibility with MongoDB's reference field query behavior
- **Enhanced Robustness**: Proper handling of `ObjectId` values in all query scenarios
- **Backward Compatibility**: Full support for existing code with automatic compatibility
- **Comprehensive Testing**: New test cases ensure reliability across different query patterns
- **Developer Experience**: More forgiving API that handles common `ObjectId` usage patterns gracefully

## Migration Notes

### For Existing Code

All existing code continues to work unchanged. The `ObjectId` type conversion enhancements are fully backward compatible with existing query patterns.

### New Usage Patterns

The following usage patterns are now properly supported:

```python
# Previously this might not work correctly for reference fields:
result = collection.find({"author_id": ObjectId("507f1f77bcf86cd799439011")})  # Now works correctly

# $in operator with ObjectIds in reference fields:
result = collection.find({"user_id": {"$in": [ObjectId("..."), ObjectId("...")]}})  # Now works correctly

# $or operator with ObjectIds in reference fields:
result = collection.find({"$or": [{"author_id": ObjectId("...")}, {"status": "published"}]})  # Now works correctly
```

## Installation

```bash
# Standard installation
pip install neosqlite==1.2.3

# For enhanced JSON/JSONB support
pip install neosqlite[jsonb]==1.2.3

# For memory-constrained processing of large result sets
pip install neosqlite[memory-constrained]==1.2.3

# Install multiple extras
pip install neosqlite[jsonb,memory-constrained]==1.2.3
```

This release represents continued improvement in NeoSQLite's MongoDB compatibility, with enhanced `ObjectId` type conversion providing better support for reference field queries while maintaining full backward compatibility with existing applications.
